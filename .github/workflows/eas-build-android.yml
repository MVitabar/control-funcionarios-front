name: EAS Build Android

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "EAS profile to use (development, preview, production)"
        required: true
        default: "preview"
  push:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install EAS CLI
        run: bun add -g eas-cli@latest

      - name: Login to Expo (using EXPO_TOKEN)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # login non-interactive so eas commands work
          eas login --token $EXPO_TOKEN || true
          eas whoami
          
      - name: Setup EAS project
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Setting up EAS project..."
          
          # Create .eas directory if it doesn't exist
          mkdir -p .eas/build
          
          # Create project.json if it doesn't exist
          if [ ! -f ".eas/project.json" ]; then
            echo '{"projectId": "a651b883-14e9-42ff-bac1-7a20de320c88"}' > .eas/project.json
          fi
          
          # Create build profile if it doesn't exist
          if [ ! -f ".eas/build/profiles.json" ]; then
            echo '{
              "preview": {
                "android": {
                  "buildType": "apk",
                  "gradleCommand": ":app:assembleDebug"
                },
                "ios": {
                  "resourceClass": "m-medium"
                }
              },
              "production": {
                "android": {
                  "buildType": "app-bundle"
                }
              }
            }' > .eas/build/profiles.json
          fi
          
          # Create build configuration if it doesn't exist
          if [ ! -f ".eas/build/config.json" ]; then
            echo '{"builds":{"android-preview":{"preview":{"android":{"buildType":"apk"}}}}}' > .eas/build/config.json
          fi
          
          # Skip credentials check in CI since they should be pre-configured
          echo "Skipping interactive credentials check in CI..."
          echo "Make sure you've run 'eas credentials' locally to set up Android signing"
          
          echo "Project files:"
          ls -la .eas/ .eas/build/ 2>/dev/null || true
          
          # Verify expo config
          echo "Verifying Expo config..."
          npx expo config --json > /dev/null || echo "Warning: expo config check failed"

      - name: Run EAS build (non-interactive) and save JSON
        id: eas_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -o pipefail
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          echo "Starting EAS build with profile: $PROFILE"
          # Run eas build and capture JSON output
          echo "Running EAS build..."
          BUILD_OUTPUT=$(eas build --platform android --profile "$PROFILE" --non-interactive --json 2>&1) || {
            echo "EAS build command failed, but continuing to process output..."
            echo "Build output: $BUILD_OUTPUT"
          }
          echo "$BUILD_OUTPUT" > build-output.json
          echo "Build output saved to build-output.json"
          
          # Check if we got valid JSON output
          if jq -e . >/dev/null 2>&1 <<<"$BUILD_OUTPUT"; then
            echo "Valid JSON output received"
            echo "::set-output name=buildjson::$(echo "$BUILD_OUTPUT" | jq -c . | sed 's/\"/\\\\\"/g')"
          else
            echo "No valid JSON output from EAS build command"
            echo "::set-output name=buildjson::{}"
          fi

      - name: Parse build output and download artifact
        if: always()
        run: |
          # Read build output JSON
          if [ ! -f "build-output.json" ]; then
            echo "No build-output.json found â€” the build may have failed to start."
            exit 0
          fi
          
          build_json=$(cat build-output.json)
          echo "Build output JSON content:"
          echo "$build_json"
          
          # Try to extract URL for Android artifact (apk or aab)
          artifact_url=$(echo "$build_json" | jq -r '.[] | select(.platform=="ANDROID") | .artifacts.applicationArchiveUrl // empty' 2>/dev/null)
          
          if [ -z "$artifact_url" ] || [ "$artifact_url" = "null" ]; then
            echo "No artifact URL in build output. The build may be queued or still processing. Check the Expo dashboard."
            # Try to get build ID to provide a direct link
            build_id=$(echo "$build_json" | jq -r '.[0].id // empty' 2>/dev/null)
            if [ -n "$build_id" ]; then
              echo "Build ID: $build_id"
              echo "Check build status at: https://expo.dev/accounts/martinvitabar/projects/control-funcionarios/builds/$build_id"
            fi
            exit 0
          fi
          
          echo "Downloading artifact from: $artifact_url"
          mkdir -p build-artifacts
          
          # Download the artifact with a proper file extension
          if [[ "$artifact_url" == *.apk ]]; then
            artifact_path="build-artifacts/app-build.apk"
          elif [[ "$artifact_url" == *.aab ]]; then
            artifact_path="build-artifacts/app-bundle.aab"
          else
            # If we can't determine the type, use a generic name
            artifact_path="build-artifacts/app-build"
          fi
          
          curl -L -o "$artifact_path" "$artifact_url"
          
          # List downloaded artifacts
          echo "Downloaded artifacts:"
          ls -lh build-artifacts/
          
          # Save artifact path for the next step
          echo "ARTIFACT_PATH=$artifact_path" >> $GITHUB_ENV

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expo-build-artifacts
          path: |
            build-output.json
            build-artifacts/
          retention-days: 7
          if-no-files-found: warn
          compression-level: 6
