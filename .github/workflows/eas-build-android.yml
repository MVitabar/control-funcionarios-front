name: EAS Build Android

on:
  workflow_dispatch:
    inputs:
      profile:
        description: "EAS profile to use (development, preview, production)"
        required: true
        default: "preview"
  push:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install EAS CLI
        run: bun add -g eas-cli@latest

      - name: Login to Expo (using EXPO_TOKEN)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # login non-interactive so eas commands work
          eas login --token $EXPO_TOKEN || true
          eas whoami
          
      - name: Setup EAS project
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          # Create .eas directory if it doesn't exist
          mkdir -p .eas
          
          # Create project.json with the provided project ID
          echo '{"projectId":"a651b883-14e9-42ff-bac1-7a20de320c88"}' > .eas/project.json
          
          # Verify the project is linked
          echo "Project configuration:"
          cat .eas/project.json

      - name: Run EAS build (non-interactive) and save JSON
        id: eas_build
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -o pipefail
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          echo "Starting EAS build with profile: $PROFILE"
          # Run eas build and capture JSON output
          BUILD_OUTPUT=$(eas build --platform android --profile "$PROFILE" --non-interactive --json) || true
          echo "$BUILD_OUTPUT" > build-output.json
          echo "Build output saved to build-output.json"
          
          # Check if we got valid JSON output
          if jq -e . >/dev/null 2>&1 <<<"$BUILD_OUTPUT"; then
            echo "Valid JSON output received"
            echo "::set-output name=buildjson::$(echo "$BUILD_OUTPUT" | jq -c . | sed 's/\"/\\\\\"/g')"
          else
            echo "No valid JSON output from EAS build command"
            echo "::set-output name=buildjson::{}"
          fi

      - name: Parse download URL and download artifact
        if: always()
        run: |
          # read JSON and try to get artifact URL
          build_json="$(cat build-output.json || true)"
          if [ -z "$build_json" ]; then
            echo "No build-output.json found â€” the build may have failed to start."
            exit 0
          fi
          # Try to extract URL for Android artifact (apk or aab)
          apk_url=$(echo "$build_json" | jq -r '.[] | select(.platform=="ANDROID") | .artifacts.applicationArchiveUrl' 2>/dev/null)
          echo "artifact URL: $apk_url"
          if [ -z "$apk_url" ] || [ "$apk_url" = "null" ]; then
            echo "No artifact URL in build output. The build may be queued or still processing. Check the Expo dashboard."
            exit 0
          fi
          curl -L -o app-build.android "$apk_url"
          ls -lh app-build.android

      - name: Upload APK / AAB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: expo-artifact
          path: app-build.android
